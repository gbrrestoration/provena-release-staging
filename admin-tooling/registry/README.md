# Registry admin tools

The registry is a critical part of infrastructure for Provena which sometimes requires administrative management.

The admin tools in this folder follow the same principles described in the parent folder. See this README for env setup instructions.

Being a typer CLI - use `python script_name.py --help` to view the autogenerated help menu.

## Importing

You can use `python import_export.py import-items <stage> <input_file> <import mode>` syntax to import items.

Pay attention to the import mode, described below:

```
ADD ONLY - will only add items - all items must be new and not exist in current
registry.

ADD_OR_OVERWRITE - will only add or overwrite existing items. This form of
import will always validate as any items are valid.

OVERWRITE_ONLY - all items must already exist in the registry, update will be
applied with the new contents.

SYNC_ADD_OR_OVERWRITE - sync mode is the same as ADD OR OVERRIDE but also
enforces that there are no items in the current table which are not in the
import items payload. If there are such items, this validation will fail -
consider using the item below.

SYNC_DELETION_ALLOWED - this will perform whatever is necessary to make the
current registry table be identical to the provided items, including potentially
deleting existing entries. USE WITH CAUTION. You must specify
allow_entry_deletion explicitly to enable deletion.
```

The import file must follow the syntax of the export tool below.

See `--help` for more information on options.

## Exporting

You can use `python import_export.py export-items <stage>` to export all items from a given deployment's registry. This exports the main table, lock and auth tables and bundles them into a json file at a prompted location.

These exports work directly with the import files.

See `--help` for more information on options.

## Restoring provenance

### Refreshing provenance graph

If the provenance graph requires refreshing, follow this procedure

- export current items from registry using export-items
- (optional) use `../prov-store/graph_admin.py` to clear the prov graph (proceed with caution)
- perform import in trial mode (do not include `--apply` flag) e.g. `python import_export.py import-items DEV dump.json OVERWRITE_ONLY` - check the result is sensible!
- add the `--restore-graph` flag (or use the standalone restore-graph command)
  - You need to use the --apply flag explicitly in the restore-graph command to actually lodge the jobs.
- run and follow prompts, if you get errors on particular nodes, these will be dumped into a file at the conclusion of the script so you can try re-running just the effected nodes

Note: ensure you have admin for the Registry and Job Apis

Note: you will need to ensure that all linked entities referenced are linked appropriately. For example, if using this tool to move data from one deployment to another, you will need to also copy the contents of the username person link table or otherwise modify the contents to make sense. The link service is used at runtime to resolve these links.
